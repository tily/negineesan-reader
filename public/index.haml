!!! 5
%html
	%head
		%meta{charset: 'utf-8'}
		%meta{name:"viewport",content:"width=device-width,initial-scale=1.0"}
		%script{src:"js/jquery.min.js",type:"text/javascript"}
		%script{src:"js/jquery.bottom-1.0.js",type:"text/javascript"}
		%script{src:"js/jquery.inview.min.js",type:"text/javascript"}
		%script{src:"js/bootstrap.min.js",type:"text/javascript"}
		%link{rel:'stylesheet',href:'css/bootstrap.min.css'}
		:css
			html, body {
				height: 100%;
			}
			img {
				width: 100%;
				margin-top: 4.0em;
				margin-bottom: 120%;
			}
			a, a:hover, a:visited {
				color: #68e5e5;
			}
			nav {
				padding-top: 0.5em;
				padding-bottom: 0.5em;
				background-color: black;
				color: white;
			}
			div#content {
				height: 100%;
				overflow: scroll;
			}
			div#loading {
				display: none;
				padding-bottom: 1em;
			}
		:coffeescript
			window.onerror = (error, url, line) -> alert error

			class NegineesanReader
				busy: false
				pos: null
				log: (msg)->
					$('#debug').append $('<li>').html(msg)
				url: (num)->
					url = 'http://negineesan.com/comics/negi/negi'
					url += if num < 1000 then @pad(num, 3) else num.toString()
					url += '.jpg'
					url
				num: (num)->
					if num
						window.location.hash = num.toString()
						$('#num').html('<strong>' + num + '</strong> 話')
					else
						match = window.location.hash.match(/^#(.+)/)
						if match then parseInt(match[1]) else 1
				pad: (num, len)->
					(Array(len).join('0') + num).slice(-len)
				add: (num)->
					@busy = true
					$('#num').html('読み込み中')
					img = $('<img>')
					img.attr 'src', @url(num)
					img.attr 'data-num', num
					img.on 'inview', ()=>
						@num parseInt img.attr('data-num')
					img.on 'load', ()=>
						$('#content').append img
						@busy = false
					img.on 'touchstart', (e)=>
						@pos = e.originalEvent.changedTouches[0].pageX
					img.on 'touchend', (e)=>
						return if @busy
						end = e.originalEvent.changedTouches[0].pageX
						if Math.abs(@pos - end) > 100
							num = parseInt img.attr('data-num')
							$('img').remove()
							@add num - (@pos - end) / Math.abs(@pos - end)
							window.scrollBy 0, document.height * (-1)

			$(document).on 'ready', ()->
				reader = new NegineesanReader()
				$('#content').bottom().on 'bottom', ()->
					return if reader.busy
					reader.add(reader.num() + 1)
				reader.add reader.num()
				
	%body
		%nav.navbar.navbar-fixed-top
			%div.container{style:'padding-top:0.5em'}
				%a#top{href:'http://negineesan.com/',target:'_blank'} ねぎ姉さん
				リーダー
				%span#num 読み込み中
				%a.pull-right{"data-toggle"=>"modal","data-target"=>"#help","href"=>'#'} ?
		%div#content
		%div.modal.fade#help{"tabindex"=>"-1","role"=>"dialog","aria-labelledby"=>"modalLabel","aria-hidden"=>"true"}
			%div.modal-dialog
				%div.modal-content
					%div.modal-header
						%button.close{"type"=>"button","data-dismiss"=>"modal"}
							%span{"aria-hidden"=>"true"} &times;
							%span.sr-only Close
						%h4.modal-title#modalLabel ヘルプ
						%div.modal-body
							%table.table
								%tr
									%td
										%strong 左右
									%td 前の話／次の話へ
								%tr
									%td
										%strong 下
									%td 次の話を継ぎ足す
